name: Deploy Laravel to Amazon Linux

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Application via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY }}
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USERNAME }}
        run: |
          mkdir -p ~/.ssh/
          
          # 1. √âcriture de la cl√© dans un fichier temporaire
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          
          # -----------------------------------------------------------
          # CORRECTION AUTOMATIQUE DU FORMAT (Windows -> Linux)
          # -----------------------------------------------------------
          # Supprime les retours chariot (\r) qui corrompent la cl√© sous Linux
          tr -d '\r' < ~/.ssh/id_rsa > ~/.ssh/id_rsa.clean
          mv ~/.ssh/id_rsa.clean ~/.ssh/id_rsa
          
          # Ajoute un saut de ligne final de s√©curit√© (requis par OpenSSH)
          echo "" >> ~/.ssh/id_rsa
          # -----------------------------------------------------------

          # 2. Permissions strictes obligatoires
          chmod 600 ~/.ssh/id_rsa

          # 3. Ajout du serveur aux h√¥tes connus pour √©viter le blocage "Host unknown"
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          # 4. Connexion et ex√©cution des commandes Laravel
          echo "D√©marrage de la connexion SSH..."
          
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $USER@$HOST "bash -s" << 'EOF'
            
            # Arr√™ter le script imm√©diatement si une commande √©choue
            set -e
            
            echo "‚úÖ Connexion r√©ussie sur le serveur !"
            
            # Navigation vers le dossier
            cd /usr/share/nginx/html/mwinda || { echo "‚ùå Dossier introuvable"; exit 1; }

            # Mise √† jour du code
            echo "üì• R√©cup√©ration du code..."
            git fetch --all --prune
            git reset --hard origin/master
            git clean -fd

            # Installation des d√©pendances
            echo "üì¶ Installation Composer..."
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-progress

            # Commandes Laravel
            echo "üöÄ Optimisations Laravel..."
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "üéâ D√©ploiement termin√© avec succ√®s."
          EOF
