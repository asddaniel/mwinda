name: Deploy Laravel to Amazon Linux

on:
  push:
    branches:
      - master

jobs:
  deploy:
    # CHANGEMENT 1 : On force une version d'Ubuntu plus ancienne et stable
    # Cela Ã©vite les problÃ¨mes de compatibilitÃ© OpenSSL 3.0 des versions rÃ©centes
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # CHANGEMENT 2 : On utilise un spÃ©cialiste pour charger la clÃ©
      # Cette action charge la clÃ© directement en mÃ©moire (RAM) de l'agent SSH.
      # Elle gÃ¨re elle-mÃªme les problÃ¨mes de formatage Windows/Linux.
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy Application
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USERNAME }}
        run: |
          # Plus besoin de crÃ©er de fichier id_rsa, l'agent s'en occupe.
          
          # On ajoute juste le serveur aux connus pour Ã©viter la question "Are you sure?"
          mkdir -p ~/.ssh
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          echo "ðŸš€ Tentative de connexion via l'agent SSH..."
          
          # Note l'option -A (Forward Agent) qui utilise la clÃ© chargÃ©e en mÃ©moire
          ssh -o StrictHostKeyChecking=no -A $USER@$HOST "bash -s" << 'EOF'
            
            set -e
            echo "âœ… CONNEXION RÃ‰USSIE !"
            
            # Tes commandes habituelles
            cd /usr/share/nginx/html/mwinda || exit 1
            
            echo "ðŸ“¥ Git Pull..."
            git fetch --all --prune
            git reset --hard origin/master
            
            echo "ðŸ“¦ Composer..."
            composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-progress
            
            echo "ðŸ”§ Artisan..."
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "ðŸŽ‰ TerminÃ©."
          EOF
